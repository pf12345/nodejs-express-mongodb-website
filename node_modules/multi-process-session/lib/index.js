// Generated by CoffeeScript 1.7.1

/*
Created by massimo on 2014/4/14.
 */

(function() {
  var redisHelper, uuid, _;

  redisHelper = require("./redisHelper");

  uuid = require("node-uuid");

  _ = require("underscore");


  /*
  配置session
  @param app
  @param type 类型: cookie 或 token
   */

  module.exports = function(app, type, expireHour) {
    if (!_.isNumber(expireHour)) {
      expireHour = 24 * 7;
    }
    return app.use(function(req, res, next) {
      var sid;
      sid = "";
      if (_.isUndefined(type) || (type === "cookie")) {
        if (req.cookies) {
          sid = req.cookies.sid;
          if (!sid) {
            sid = uuid.v4();
          }
          res.cookie("sid", sid, {
            maxAge: 3600000 * expireHour
          });
        }
      } else {
        sid = req.query.Token;
      }
      if (sid) {
        res.on("finish", function() {
          if (res.session) {
            return redisHelper.setSession(sid, res.session, function(err) {
              if (err) {
                return console.error(err);
              }
            });
          }
        });
        return redisHelper.getSession(sid, function(err, session) {
          if (err) {
            console.dir(err);
            return next(err);
          } else {
            res.session = req.session = session;
            res.session.clear = function() {
              res.session = null;
              return redisHelper.removeSession(sid);
            };
            req.sessionId = sid;
            return next();
          }
        });
      } else {
        res.session = req.session = {};
        return next();
      }
    });
  };

}).call(this);

//# sourceMappingURL=index.map
